"""
Test that school sizes are being generated by school type when with_school_types is turned on and data is available.
"""

import sciris as sc
import synthpops as sp
import numpy as np
import matplotlib as mplt
import matplotlib.pyplot as plt
import cmasher as cmr
import cmocean
import pytest

mplt.rcParams['font.family'] = 'Roboto Condensed'
mplt.rcParams['font.size'] = 7


# parameters to generate a test population
pars = sc.objdict(
    n                               = 20e3,
    rand_seed                       = 123,
    max_contacts                    = None,

    country_location                = 'usa',
    state_location                  = 'Washington',
    location                        = 'Franklin_County',
    use_default                     = True,

    household_method                = 'fixed_ages',

    with_facilities                 = 1,
    with_non_teaching_staff         = 1,
    with_school_types               = 1,

    school_mixing_type              = {'pk': 'age_and_class_clustered', 'es': 'age_and_class_clustered', 'ms': 'age_and_class_clustered', 'hs': 'random', 'uv': 'random'},  # you should know what school types you're working with
)


def test_school_types_created():
    """
    Test that unique school types are created.

    Returns:
        A list of the school types expected for the specified location.
    """
    sp.logger.info(f"Test that unique school types are created for each school.\nRun this first to see what school types you are working with.")

    test_pars = sc.dcp(pars)
    test_pars['n'] = 10e3
    pop = sp.Pop(**test_pars)
    popdict = pop.to_dict()
    loc_pars = pop.loc_pars

    if pars['with_school_types']:
        expected_school_size_distr = sp.get_school_size_distr_by_type(**loc_pars)
        expected_school_types = sorted(expected_school_size_distr.keys())
    else:
        expected_school_types = [None]

    schools_by_type = dict()
    for i, person in popdict.items():
        if person['scid'] is not None:
            schools_by_type.setdefault(person['scid'], set())
            schools_by_type[person['scid']].add(person['sc_type'])

    for s, school_type in schools_by_type.items():
        assert len(school_type) == 1, f'Check failed. School {s} is listed as having more than one type.'
        schools_by_type[s] = list(school_type)[0]

    gen_school_types = sorted(set(schools_by_type.values()))
    assert gen_school_types == expected_school_types, f"Check failed. generated types: {gen_school_types}, expected: {expected_school_types}"

    print(f"School types generated for {test_pars['location']}: {set(schools_by_type.values())}")

    return list(set(schools_by_type.values()))


def plot_school_sizes_by_type(pop, pars, do_show=False):
    """
    Plot the school size distribution by type compared with the expected data.
    """
    sp.logger.info(f"Plotting to show that school sizes are generated by school type when the parameter 'with_school_types' is set to True.")
    popdict = pop.to_dict()

    kwargs = sc.dcp(pars)
    kwargs.cmap = cmr.get_sub_cmap('cmo.curl', 0.06, 1)
    fig, ax = pop.plot_school_sizes_by_type(**kwargs)  

    loc_pars = pop.loc_pars

    school_size_brackets = sp.get_school_size_brackets(**loc_pars)
    bins = [school_size_brackets[0][0]] + [school_size_brackets[b][-1] + 1 for b in school_size_brackets]

    enrollment_by_school_type = sp.get_enrollment_by_school_type(popdict)
    gen_school_size_distr = sp.get_generated_school_size_distributions(enrollment_by_school_type, bins)

    sorted_school_types = sorted(gen_school_size_distr.keys())

    return fig, ax, sorted_school_types


@pytest.mark.parametrize("pars", [pars])
def test_school_sizes_by_type(pars, do_show=False):
    """
    Visually show how the school size distribution generated compares to the
    data for the location being simulated.

    Notes:
        The larger the population size, the better the generated school size
        distributions by school type can match the expected data. If generated
        populations are too small, larger schools will be missed and in
        general there won't be enough schools generated to apply statistical
        tests.
    """
    sp.logger.info("Creating schools by school type and a visual comparison of how they match to data.")
    pop = sp.Pop(**pars)
    fig, ax, school_types = plot_school_sizes_by_type(pop, pars, do_show=do_show)

    return pop, fig, ax, school_types


@pytest.mark.parametrize("pars", [pars])
def test_separate_school_types_for_seattle_metro(pars, do_show=False):
    """
    Notes:
        By default, when no location is given and use_default is set to True,
        data pulled in will be for seattle metro and school type data will
        default to previous seattle metro data with pre-k and elementary kept
        separate.
    """
    sp.logger.info("Creating schools where pre-k and elementary schools are separate.")
    test_pars = sc.dcp(pars)
    test_pars['location'] = None  # seattle_metro results with school size distribution the same for all types
    pop = sp.Pop(**test_pars)
    fig, ax, school_types = plot_school_sizes_by_type(pop, test_pars, do_show=do_show)

    assert ('pk' in school_types) and ('es' in school_types), 'Check failed. pk and es school type are not separately created.'
    print('Check passed.')

    return pop, fig, ax, school_types


def test_without_school_types(do_show=False):
    """
    Test that without school types, all schools are put together in one group.
    """
    sp.logger.info("Creating schools where with_school_types is False.")
    test_pars = sc.dcp(pars)
    test_pars['with_school_types'] = False
    pop = sp.Pop(**test_pars)
    fig, ax, school_types = plot_school_sizes_by_type(pop, test_pars, do_show=do_show)
    return pop, fig, ax, school_types


if __name__ == '__main__':

    # run as main to see the code and figures in action!

    sc.tic()

    school_types = test_school_types_created()
    pop, fig, ax, school_types = test_school_sizes_by_type(pars, do_show=True)
    pop2, fig2, ax2, school_types2 = test_separate_school_types_for_seattle_metro(pars, do_show=True)
    pop3, fig3, ax3, school_types3 = test_without_school_types(do_show=True)

    plt.show()
    sc.toc()
